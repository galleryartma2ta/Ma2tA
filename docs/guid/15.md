**پیاده‌سازی پشتیبانی از چند درگاه پرداخت در پروژه Ma2tA**  
برای افزودن قابلیت پشتیبانی از چند درگاه پرداخت (مثل زرین‌پال، آیدی پی، و نوین) و مدیریت یکپارچه تراکنش‌ها، مراحل زیر را دنبال کنید:

---

### **۱. طراحی معماری سیستم پرداخت**
#### **الگوی طراحی (Strategy Pattern)**
- **Payment Gateway Interface:**  
  ```go
  type PaymentGateway interface {
      InitiatePayment(amount int64, callbackURL string) (paymentURL string, err error)
      VerifyPayment(paymentID string) (success bool, err error)
      Refund(paymentID string) (success bool, err error)
  }
  ```

#### **ساختار دیتابیس**
- **جدول `payment_gateways`:**  
  | فیلد         | نوع داده     | توضیحات                     |  
  |--------------|-------------|----------------------------|  
  | `id`         | UUID        | شناسه یکتا                 |  
  | `name`       | VARCHAR     | نام درگاه (زرین‌پال، آیدی پی، ...) |  
  | `is_active`  | BOOLEAN     | وضعیت فعال/غیرفعال         |  
  | `config`     | JSONB       | تنظیمات (API Key, Merchant ID, ...) |  

- **جدول `transactions`:**  
  | فیلد            | نوع داده     | توضیحات                     |  
  |-----------------|-------------|----------------------------|  
  | `id`            | UUID        | شناسه تراکنش               |  
  | `gateway_id`    | UUID        | شناسه درگاه پرداخت         |  
  | `amount`        | BIGINT      | مبلغ به ریال               |  
  | `status`        | ENUM        | وضعیت (pending, success, failed) |  
  | `payment_id`    | VARCHAR     | شناسه پرداخت در درگاه      |  

---

### **۲. پیاده‌سازی درگاه‌های پرداخت**  
#### **الف) درگاه زرین‌پال (Zarinpal)**  
```go
type ZarinpalGateway struct {
    MerchantID  string
    Sandbox     bool
}

func (z *ZarinpalGateway) InitiatePayment(amount int64, callbackURL string) (string, error) {
    // فراخوانی API زرین‌پال
    req := map[string]interface{}{
        "merchant_id":  z.MerchantID,
        "amount":       amount,
        "callback_url": callbackURL,
        "description":  "خرید از Ma2tA",
    }
    // ارسال درخواست و دریافت لینک پرداخت
}

func (z *ZarinpalGateway) VerifyPayment(paymentID string) (bool, error) {
    // بررسی وضعیت پرداخت
}
```

#### **ب) درگاه آیدی پی (IDPay)**  
```go
type IDPayGateway struct {
    APIKey string
}

func (i *IDPayGateway) InitiatePayment(amount int64, callbackURL string) (string, error) {
    // فراخوانی API آیدی پی
}
```

---

### **۳. سرویس مدیریت پرداخت (Payment Service)**  
#### **الف) انتخاب درگاه پرداخت**  
```go
func GetActiveGateway() (PaymentGateway, error) {
    var gateway PaymentGateway
    // دریافت درگاه فعال از دیتابیس
    err := db.Where("is_active = ?", true).First(&gateway).Error
    return gateway, err
}
```

#### **ب) ایجاد تراکنش**  
```go
func CreateTransaction(amount int64, userID string) (*Transaction, error) {
    gateway, _ := GetActiveGateway()
    callbackURL := "https://ma2ta.com/payment/verify"
    
    paymentURL, err := gateway.InitiatePayment(amount, callbackURL)
    if err != nil {
        return nil, err
    }
    
    // ذخیره تراکنش در دیتابیس
    tx := Transaction{
        GatewayID:  gateway.ID,
        Amount:     amount,
        Status:     "pending",
        PaymentID:  paymentID,
    }
    db.Create(&tx)
    
    return &tx, nil
}
```

---

### **۴. APIهای پرداخت**  
#### **الف) شروع پرداخت**  
```http
POST /api/payment/create
Authorization: Bearer <token>
Content-Type: application/json

{ "amount": 100000 }
```

#### **ب) تایید پرداخت**  
```http
GET /api/payment/verify?payment_id=12345&status=OK
```

---

### **۵. مدیریت خطاها و Fallback**  
- **Fallback خودکار:**  
  اگر درگاه اصلی پاسخ ندهد، به صورت خودکار به درگاه پشتیبان سوئیچ کند.  
  ```go
  func ProcessPayment(amount int64) (string, error) {
      gateways := GetActiveGateways() // لیست درگاه‌های فعال به ترتیب اولویت
      for _, gateway := range gateways {
          paymentURL, err := gateway.InitiatePayment(amount)
          if err == nil {
              return paymentURL, nil
          }
      }
      return "", errors.New("تمام درگاه‌ها ناموفق بودند")
  }
  ```

---

### **۶. امنیت**  
- **رمزنگاری داده‌های حساس:**  
  ذخیره‌سازی `API Key` و `Merchant ID` با استفاده از رمزنگاری AES.  
- **اعتبارسنجی IP:**  
  تایید IP درگاه‌های پرداخت برای جلوگیری از درخواست‌های جعلی.  

---

### **۷. تست‌ها**  
#### **الف) تست واحد برای درگاه زرین‌پال**  
```go
func TestZarinpalPayment(t *testing.T) {
    gateway := ZarinpalGateway{MerchantID: "test", Sandbox: true}
    url, err := gateway.InitiatePayment(10000, "https://callback")
    assert.NoError(t, err)
    assert.Contains(t, url, "zarinpal.com")
}
```

#### **ب) تست یکپارچه‌سازی**  
```go
func TestPaymentFlow(t *testing.T) {
    // ایجاد تراکنش
    tx, _ := CreateTransaction(10000, "user123")
    // شبیه‌سازی بازگشت از درگاه
    success, _ := VerifyPayment(tx.PaymentID)
    assert.True(t, success)
}
```

---

### **۸. مستندات توسعه‌دهندگان**  
برای افزودن درگاه جدید:  
۱. پیاده‌سازی اینترفیس `PaymentGateway`.  
۲. ثبت درگاه در دیتابیس با تنظیمات مربوطه.  
۳. افزودن تست‌های لازم.  

---

**نتیجه نهایی:**  
با این معماری، پروژه Ma2tA می‌تواند از **چندین درگاه پرداخت** به صورت همزمان پشتیبانی کند و در صورت بروز مشکل در یک درگاه، به صورت خودکار از درگاه جایگزین استفاده کند! 💳🚀