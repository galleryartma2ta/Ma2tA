**راهنمای جامع دیپلوی پروژه Ma2tA**

---

### **۱. انتخاب پلتفرم میزبانی**
- **گزینه‌های محبوب:**  
  - **سرور ابری:** AWS, DigitalOcean, Google Cloud, Hetzner  
  - **پلتفرم‌های مدیریت شده:** Heroku, Railway, Render  
  - **هاستینگ اختصاصی:** VPS یا سرور اختصاصی  

---

### **۲. آماده‌سازی سرور**
#### **الف) ایجاد سرور (مثال: Ubuntu 22.04)**
1. **اتصال به سرور از طریق SSH:**
   ```bash
   ssh root@your-server-ip
   ```

2. **به‌روزرسانی سیستم:**
   ```bash
   sudo apt update && sudo apt upgrade -y
   ```

3. **نصب Docker و Docker Compose:**
   ```bash
   sudo apt install docker.io docker-compose
   sudo systemctl enable docker
   sudo systemctl start docker
   ```

---

### **۳. تنظیمات پروژه برای Production**
#### **الف) تغییرات در کد**
1. **غیرفعال کردن حالت Debug (بک‌اند):**
   ```env
   # فایل .env
   GIN_MODE=release
   ```

2. **استفاده از دیتابیس Production (PostgreSQL):**
   ```env
   DB_HOST=postgres
   DB_PORT=5432
   DB_USER=ma2ta
   DB_PASSWORD=your_secure_password
   DB_NAME=ma2ta
   ```

3. **تنظیمات فرانت‌اند (تغییر آدرس API):**
   ```env
   VITE_API_URL=https://api.ma2ta.com
   ```

---

### **۴. دیپلوی با Docker Compose**
1. **ایداره فایل `docker-compose.prod.yml`:**
   ```yaml
   version: '3.8'

   services:
     postgres:
       image: postgres:15
       volumes:
         - postgres_data:/var/lib/postgresql/data
       environment:
         POSTGRES_USER: ma2ta
         POSTGRES_PASSWORD: your_secure_password
         POSTGRES_DB: ma2ta

     backend:
       build: ./backend
       ports:
         - "8080:8080"
       environment:
         - GIN_MODE=release
         - DB_HOST=postgres
         - DB_PORT=5432
         - DB_USER=ma2ta
         - DB_PASSWORD=your_secure_password
         - DB_NAME=ma2ta
       depends_on:
         - postgres

     frontend:
       build: ./frontend
       ports:
         - "80:3000"

     nginx:
       image: nginx:alpine
       ports:
         - "80:80"
         - "443:443"
       volumes:
         - ./nginx.conf:/etc/nginx/nginx.conf
         - ./ssl:/etc/nginx/ssl
       depends_on:
         - backend
         - frontend

   volumes:
     postgres_data:
   ```

2. **ساخت و اجرای کانتینرها:**
   ```bash
   docker-compose -f docker-compose.prod.yml up -d --build
   ```

---

### **۵. تنظیم Nginx به عنوان Reverse Proxy**
1. **فایل `nginx.conf`:**
   ```nginx
   events {}

   http {
       server {
           listen 80;
           server_name ma2ta.com www.ma2ta.com;

           location / {
               proxy_pass http://frontend:3000;
           }

           location /api {
               proxy_pass http://backend:8080;
               proxy_set_header Host $host;
           }
       }

       # HTTPS Configuration (پس از دریافت SSL)
       server {
           listen 443 ssl;
           server_name ma2ta.com www.ma2ta.com;

           ssl_certificate /etc/nginx/ssl/fullchain.pem;
           ssl_certificate_key /etc/nginx/ssl/privkey.pem;

           location / {
               proxy_pass http://frontend:3000;
           }

           location /api {
               proxy_pass http://backend:8080;
               proxy_set_header Host $host;
           }
       }
   }
   ```

---

### **۶. فعال‌سازی HTTPS با Let's Encrypt**
1. **نصب Certbot:**
   ```bash
   sudo apt install certbot python3-certbot-nginx
   ```

2. **دریافت گواهی SSL:**
   ```bash
   sudo certbot --nginx -d ma2ta.com -d www.ma2ta.com
   ```

3. **تست تمدید خودکار:**
   ```bash
   sudo certbot renew --dry-run
   ```

---

### **۷. تنظیم CI/CD با GitHub Actions**
1. **فایل `.github/workflows/deploy.yml`:**
   ```yaml
   name: Deploy to Production

   on:
     push:
       branches: [main]

   jobs:
     deploy:
       runs-on: ubuntu-latest
       steps:
         - name: Checkout code
           uses: actions/checkout@v3

         - name: Deploy with Docker Compose
           uses: appleboy/ssh-action@master
           with:
             host: your-server-ip
             username: root
             key: ${{ secrets.SSH_PRIVATE_KEY }}
             script: |
               cd /opt/ma2ta
               git pull
               docker-compose -f docker-compose.prod.yml up -d --build
   ```

---

### **۸. Backup و بازیابی**
#### **الف) Backup دیتابیس**
```bash
# Backup روزانه
docker exec ma2ta-postgres pg_dump -U ma2ta -d ma2ta > backup.sql
```

#### **ب) بازیابی دیتابیس**
```bash
cat backup.sql | docker exec -i ma2ta-postgres psql -U ma2ta -d ma2ta
```

---

### **۹. مانیتورینگ و Logging**
- **Prometheus + Grafana:** مانیتورینگ منابع سرور و برنامه  
- **ELK Stack (Elasticsearch, Logstash, Kibana):** مدیریت لاگ‌ها  
- **Uptime Robot:** مانیتورینگ آپتایم  

---

### **۱۰. بهینه‌سازی امنیتی**
1. **فایروال (UFW):**
   ```bash
   sudo ufw allow 22/tcp   # SSH
   sudo ufw allow 80/tcp   # HTTP
   sudo ufw allow 443/tcp  # HTTPS
   sudo ufw enable
   ```

2. **غیرفعال کردن ورود با رمز عبور (SSH):**
   ```bash
   sudo nano /etc/ssh/sshd_config
   # تغییر PermitRootLogin به no
   # تغییر PasswordAuthentication به no
   sudo systemctl restart sshd
   ```

---

### **مشکلات رایج و راه‌حل‌ها**
#### **۱. خطای `Connection refused` در API**
- **علت:** بک‌اند اجرا نشده یا پورت مسدود است.  
- **راه‌حل:**  
  ```bash
  docker-compose logs backend
  sudo ufw allow 8080
  ```

#### **۲. خطای SSL در مرورگر**
- **علت:** گواهی SSL منقضی یا نادرست.  
- **راه‌حل:**  
  ```bash
  sudo certbot renew --force-renewal
  docker-compose restart nginx
  ```

---

**پایان!**  
پروژه شما اکنون در محیط Production قابل دسترسی است! 🚀  
برای پشتیبانی فنی می‌توانید از [مستندات پروژه](https://github.com/yourusername/Ma2tA/wiki) استفاده کنید.