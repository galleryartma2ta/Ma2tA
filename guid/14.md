**پیاده‌سازی سیستم نظردهی و امتیازدهی در پروژه Ma2tA**  

---

### **۱. طراحی مدل داده‌ها (Database Schema)**  
برای ذخیره‌سازی نظرات و امتیازها، نیاز به جداول زیر داریم:

#### **جدول `reviews`**  
| فیلد         | نوع داده     | توضیحات                     |  
|--------------|-------------|----------------------------|  
| `id`         | UUID        | شناسه یکتا                 |  
| `product_id` | UUID        | شناسه محصول مرتبط          |  
| `user_id`    | UUID        | شناسه کاربر نظر دهنده      |  
| `rating`     | INTEGER     | امتیاز (۱ تا ۵)            |  
| `comment`    | TEXT        | متن نظر                    |  
| `created_at` | TIMESTAMP   | تاریخ ایجاد                |  
| `status`     | ENUM        | وضعیت (تایید شده/در انتظار/رد شده) |  

#### **جدول `product_stats`**  
| فیلد            | نوع داده     | توضیحات                     |  
|-----------------|-------------|----------------------------|  
| `product_id`    | UUID        | شناسه محصول                |  
| `total_ratings` | INTEGER     | تعداد کل امتیازها          |  
| `avg_rating`    | FLOAT       | میانگین امتیاز (تا ۱ رقم اعشار) |  

---

### **۲. پیاده‌سازی در بک‌اند (Go + Gin)**  

#### **الف) ثبت نظر و امتیاز**  
```go  
// مدل درخواست  
type ReviewRequest struct {  
    ProductID string `json:"product_id" binding:"required"`  
    Rating    int    `json:"rating" binding:"required,min=1,max=5"`  
    Comment   string `json:"comment" binding:"max=500"`  
}  

// هندلر ثبت نظر  
func SubmitReview(c *gin.Context) {  
    var req ReviewRequest  
    if err := c.ShouldBindJSON(&req); err != nil {  
        c.JSON(400, gin.H{"error": err.Error()})  
        return  
    }  

    // بررسی آیا کاربر قبلاً به این محصول امتیاز داده است  
    var existingReview Review  
    if err := db.Where("user_id = ? AND product_id = ?", userID, req.ProductID).First(&existingReview).Error; err == nil {  
        c.JSON(400, gin.H{"error": "شما قبلاً به این محصول امتیاز داده‌اید"})  
        return  
    }  

    // ذخیره نظر در دیتابیس  
    review := Review{  
        ProductID: req.ProductID,  
        UserID:    userID,  
        Rating:    req.Rating,  
        Comment:   req.Comment,  
        Status:    "pending", // نیاز به تایید ادمین  
    }  
    db.Create(&review)  

    // به‌روزرسانی آمار محصول  
    UpdateProductStats(req.ProductID)  

    c.JSON(200, gin.H{"message": "نظر شما با موفقیت ثبت شد و پس از تایید نمایش داده می‌شود"})  
}  
```  

#### **ب) محاسبه میانگین امتیازها**  
```go  
func UpdateProductStats(productID string) {  
    var avgRating float64  
    db.Model(&Review{}).Where("product_id = ? AND status = 'approved'", productID).Select("AVG(rating)").Row().Scan(&avgRating)  

    // گرد کردن به ۱ رقم اعشار  
    avgRating = math.Round(avgRating*10) / 10  

    // به‌روزرسانی یا ایجاد رکورد  
    db.Exec(`  
        INSERT INTO product_stats (product_id, total_ratings, avg_rating)  
        VALUES (?, ?, ?)  
        ON CONFLICT (product_id) DO UPDATE  
        SET total_ratings = EXCLUDED.total_ratings, avg_rating = EXCLUDED.avg_rating  
    `, productID, totalRatings, avgRating)  
}  
```  

---

### **۳. پیاده‌سازی در فرانت‌اند (SvelteKit)**  

#### **الف) کامپوننت امتیازدهی با ستاره**  
```svelte  
<!-- src/components/RatingStars.svelte -->  
<script>  
  export let productId;  
  export let userRating = 0;  
  let selectedRating = 0;  

  async function submitRating(rating) {  
    if (userRating !== 0) return; // کاربر قبلاً امتیاز داده  

    const res = await fetch(`/api/products/${productId}/reviews`, {  
      method: "POST",  
      headers: { "Content-Type": "application/json" },  
      body: JSON.stringify({ rating }),  
    });  

    if (res.ok) {  
      userRating = rating;  
    }  
  }  
</script>  

<div class="rating">  
  {#each [1, 2, 3, 4, 5] as i}  
    <button  
      class="star {i <= selectedRating || i <= userRating ? 'active' : ''}"  
      on:click={() => submitRating(i)}  
      on:mouseover={() => selectedRating = i}  
      on:mouseout={() => selectedRating = 0}  
    >  
      ⭐  
    </button>  
  {/each}  
</div>  

<style>  
  .star {  
    background: none;  
    border: none;  
    cursor: pointer;  
    font-size: 1.5rem;  
  }  
  .star.active {  
    color: #f59e0b;  
  }  
</style>  
```  

#### **ب) نمایش نظرات و میانگین امتیاز**  
```svelte  
<!-- src/routes/products/[id].svelte -->  
<script>  
  export let product;  
  let reviews = [];  

  async function fetchReviews() {  
    const res = await fetch(`/api/products/${product.id}/reviews`);  
    reviews = await res.json();  
  }  

  $: fetchReviews();  
</script>  

<div class="product-ratings">  
  <h3>میانگین امتیاز: {product.avg_rating}/5 ({product.total_ratings} نظر)</h3>  
  <RatingStars productId={product.id} userRating={0} />  
</div>  

<div class="reviews">  
  {#each reviews as review}  
    <div class="review">  
      <div class="rating">{'⭐'.repeat(review.rating)}</div>  
      <p>{review.comment}</p>  
      <small>ارسال شده توسط {review.user.name} در {review.created_at}</small>  
    </div>  
  {/each}  
</div>  
```  

---

### **۴. سیستم مودریشن (مدیریت نظرات)**  

#### **الف) پنل مدیریت نظرات**  
- **APIهای لازم:**  
  - `GET /admin/reviews` (لیست نظرات منتظر تایید)  
  - `PUT /admin/reviews/:id/approve` (تایید نظر)  
  - `DELETE /admin/reviews/:id` (حذف نظر)  

#### **ب) فیلتر خودکار نظرات نامناسب**  
```go  
// استفاده از سرویس‌های سوم شخص مثل Perspective API  
func containsInappropriateContent(text string) bool {  
    resp, _ := http.Post("https://commentanalyzer.googleapis.com/v1alpha1/comments:analyze", "application/json", bytes.NewBufferString(fmt.Sprintf(`{  
        "comment": { "text": "%s" },  
        "requestedAttributes": { "TOXICITY": {} }  
    }`, text)))  

    var result map[string]interface{}  
    json.NewDecoder(resp.Body).Decode(&result)  
    toxicityScore := result["attributeScores"].(map[string]interface{})["TOXICITY"].(map[string]interface{})["summaryScore"].(map[string]interface{})["value"].(float64)  

    return toxicityScore > 0.7  
}  
```  

---

### **۵. امنیت و اعتبارسنجی**  
- **محدودیت‌ها:**  
  - فقط کاربران لاگین‌شده می‌توانند نظر دهند.  
  - هر کاربر فقط یک بار می‌تواند به هر محصول امتیاز دهد.  
  - حداکثر طول نظر: ۵۰۰ کاراکتر.  
  - امتیاز باید بین ۱ تا ۵ باشد.  

---

### **۶. تست‌های نمونه**  
#### **الف) تست ثبت نظر تکراری**  
```http  
POST /api/products/abc123/reviews  
Authorization: Bearer <token>  
Content-Type: application/json  

{ "rating": 4, "comment": "عالی بود!" }  

// پاسخ: 400 Bad Request  
{ "error": "شما قبلاً به این محصول امتیاز داده‌اید" }  
```  

#### **ب) تست فیلتر نظرات نامناسب**  
```http  
POST /api/products/abc123/reviews  
Authorization: Bearer <token>  
Content-Type: application/json  

{ "rating": 1, "comment": "این محصول افتضاح است!" }  

// پاسخ: 200 OK (اما نظر با status=rejected ذخیره می‌شود)  
```  

---

**نتیجه نهایی:**  
با این سیستم، کاربران می‌توانند به راحتی نظرات خود را ثبت کنند و امتیاز دهند، در حالی که از امنیت و صحت داده‌ها اطمینان حاصل شده است! 🌟📝