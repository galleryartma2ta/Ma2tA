**راهنمای جامع تست پروژه Ma2tA (گام ۷):**

---

### **۱. تست‌های واحد (Unit Tests)**

#### **بک‌اند (Go):**
1. **ایجاد فایل تست (مثال: `handlers/product_test.go`):**
   ```go
   package handlers_test

   import (
       "net/http"
       "net/http/httptest"
       "testing"
       "github.com/gin-gonic/gin"
       "github.com/stretchr/testify/assert"
       "ma2ta/backend/handlers"
   )

   func TestGetProducts(t *testing.T) {
       // Setup
       r := gin.Default()
       r.GET("/api/v1/products", handlers.GetProducts)

       // Execute
       req, _ := http.NewRequest("GET", "/api/v1/products", nil)
       w := httptest.NewRecorder()
       r.ServeHTTP(w, req)

       // Assert
       assert.Equal(t, http.StatusOK, w.Code)
       assert.Contains(t, w.Body.String(), "products")
   }
   ```

2. **اجرای تست:**
   ```bash
   cd backend
   go test -v ./...
   ```

---

#### **فرانت‌اند (SvelteKit + Vitest):**
1. **نصب Vitest:**
   ```bash
   npm install -D vitest
   ```

2. **ایجاد فایل تست (مثال: `src/lib/product.test.js`):**
   ```javascript
   import { getProducts } from './product'
   import { describe, expect, it } from 'vitest'

   describe('getProducts', () => {
       it('should return a list of products', async () => {
           const products = await getProducts()
           expect(products).toBeInstanceOf(Array)
           expect(products.length).toBeGreaterThan(0)
       })
   })
   ```

3. **اجرای تست:**
   ```bash
   npm run test
   ```

---

#### **موبایل (Flutter):**
1. **تست ویجت (مثال: `test/widget_test.dart`):**
   ```dart
   void main() {
       testWidgets('Product list should load', (WidgetTester tester) async {
           await tester.pumpWidget(const MyApp());
           expect(find.text('محصولات'), findsOneWidget);
           await tester.pumpAndSettle();
           expect(find.byType(ProductCard), findsWidgets);
       });
   }
   ```

2. **اجرای تست:**
   ```bash
   flutter test
   ```

---

### **۲. تست‌های یکپارچه‌سازی (Integration Tests)**

#### **بک‌اند (Go + Docker):**
1. **استفاده از دیتابیس تست (SQLite در حافظه):**
   ```go
   func TestCreateProduct(t *testing.T) {
       // Setup test DB
       db, _ := sql.Open("sqlite3", ":memory:")
       defer db.Close()
       // Run migrations...
   }
   ```

2. **اجرای تست با Docker:**
   ```bash
   docker-compose -f docker-compose.test.yml up --build --abort-on-container-exit
   ```

---

#### **فرانت‌اند (Cypress):**
1. **نصب Cypress:**
   ```bash
   npm install -D cypress
   ```

2. **ایجاد تست (مثال: `cypress/e2e/products.cy.js`):**
   ```javascript
   describe('Products Page', () => {
       it('should load products', () => {
           cy.visit('/products')
           cy.get('.product').should('have.length.gt', 0)
       })
   })
   ```

3. **اجرای تست:**
   ```bash
   npx cypress open
   ```

---

### **۳. تست End-to-End (E2E)**

#### **سناریوی کامل خرید:**
1. **مراحل تست:**
   - ورود به سایت
   - افزودن محصول به سبد
   - تکمیل پرداخت
   - تأیید سفارش

2. **ابزارها:**
   - **Playwright** (برای وب)  
   - **Flutter Integration Test** (برای موبایل)

---

### **۴. تست پرداخت زرین‌پال**

#### **استفاده از حالت Sandbox:**
1. **دریافت `Merchant ID` تستی:**
   - از پنل زرین‌پال، در حالت Sandbox یک Merchant ID دریافت کنید.

2. **تست درگاه پرداخت:**
   ```bash
   curl -X POST http://localhost:8080/api/v1/payment \
        -H "Content-Type: application/json" \
        -d '{"amount": 1000, "description": "تست پرداخت"}'
   ```
   - خروجی باید شامل لینک پرداخت Sandbox باشد.

3. **تأیید پرداخت:**
   - پس از پرداخت تستی، وب‌هوک را بررسی کنید:
     ```bash
     curl http://localhost:8080/api/v1/payment/verify?Authority=xxxx&Status=OK
     ```

---

### **۵. تست عملکرد (Load Testing)**

#### **ابزار: k6**
1. **نصب k6:**
   ```bash
   sudo apt install k6
   ```

2. **سناریوی تست (مثال: `load-test.js`):**
   ```javascript
   import http from 'k6/http';

   export default function () {
       http.get('http://localhost:8080/api/v1/products');
   }
   ```

3. **اجرای تست:**
   ```bash
   k6 run --vus 100 --duration 30s load-test.js
   ```

---

### **مشکلات رایج و راه‌حل‌ها**

#### **۱. تست‌های Go با خطای دیتابیس مواجه می‌شوند**
- **راه‌حل:** از دیتابیس درون‌حافظه (مثل SQLite) برای تست استفاده کنید.

#### **۲. Cypress المنت‌ها را پیدا نمی‌کند**
- **راه‌حل:**  
  - از `data-testid` برای شناسایی المنت‌ها استفاده کنید.  
  - زمان بارگذاری را با `cy.wait()` افزایش دهید.

#### **۳. پرداخت تستی زرین‌پال تایید نمی‌شود**
- **راه‌حل:**  
  - مطمئن شوید `Merchant ID` درست است.  
  - از آدرس `https://sandbox.zarinpal.com` برای تست استفاده کنید.

---

### **نکات پیشرفته**
- **تست‌های خودکار با GitHub Actions:**  
  - افزودن Workflow برای اجرای تست‌ها روی هر Commit.
- **کدپوشانی (Code Coverage):**  
  - استفاده از `go test -cover` و `lcov` برای گزارش پوشش کد.
- **تست امنیتی:**  
  - اسکن با `OWASP ZAP` یا `Snyk`.

---

**پایان!**  
اگر نیاز به مثال‌های بیشتری دارید یا به مشکل برخوردید، می‌توانید از **[مستندات تست Ma2tA](https://github.com/yourusername/Ma2tA/tree/main/docs/testing.md)** استفاده کنید یا مشکل را گزارش دهید! 🧪🔍