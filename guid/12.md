**پیاده‌سازی پنل مدیریت برای پروژه Ma2tA**  

### **مراحل کلیدی پیاده‌سازی پنل مدیریت:**

---

### **۱. طراحی معماری پنل مدیریت**
- **نقشه ویژگی‌ها:**  
  - مدیریت محصولات (CRUD)  
  - مدیریت کاربران (فعال/غیرفعال کردن، تغییر نقش)  
  - مشاهده سفارش‌ها و تغییر وضعیت آنها  
  - گزارش‌گیری (فروش، کاربران فعال، محصولات پرفروش)  
  - تنظیمات سیستمی (درگاه پرداخت، تخفیف‌ها)  

- **نمودار معماری:**  
  ```bash
  پنل مدیریت (SvelteKit)  
  │  
  └─── API اختصاصی (Go + Gin)  
        │  
        └─── دیتابیس (PostgreSQL/MySQL)  
  ```

---

### **۲. پیاده‌سازی APIهای مدیریتی در بک‌اند (Go)**  
#### **الف) ایجاد Routeهای Protected با نقش ادمین**  
```go
// routes/admin.go  
adminGroup := r.Group("/api/admin")  
adminGroup.Use(middleware.JWTAuth())  
adminGroup.Use(middleware.AdminOnly())  

// مدیریت کاربران  
adminGroup.GET("/users", handlers.AdminListUsers)  
adminGroup.PUT("/users/:id/role", handlers.AdminUpdateUserRole)  

// مدیریت محصولات  
adminGroup.POST("/products", handlers.AdminCreateProduct)  
adminGroup.DELETE("/products/:id", handlers.AdminDeleteProduct)  
```

#### **ب) Middleware بررسی نقش ادمین**  
```go
// middleware/admin.go  
func AdminOnly() gin.HandlerFunc {  
    return func(c *gin.Context) {  
        userRole := c.GetString("role")  
        if userRole != "admin" {  
            c.AbortWithStatusJSON(403, gin.H{"error": "دسترسی ممنوع"})  
            return  
        }  
        c.Next()  
    }  
}  
```

---

### **۳. پیاده‌سازی فرانت‌اند پنل مدیریت (SvelteKit)**  
#### **الف) ایجاد ساختار پوشه‌ها**  
```bash
src/routes/admin/  
├── products/      # مدیریت محصولات  
├── users/         # مدیریت کاربران  
├── orders/        # مدیریت سفارش‌ها  
├── analytics/     # گزارش‌گیری  
└── +layout.svelte # Layout مخصوص ادمین  
```

#### **ب) کامپوننت‌های اصلی**  
- **جدول کاربران با قابلیت جستجو و صفحه‌بندی:**  
  ```svelte
  <!-- src/routes/admin/users/UsersTable.svelte -->  
  <script>
    let users = [];
    let searchTerm = "";
    
    async function fetchUsers() {
      const res = await fetch("/api/admin/users?q=" + searchTerm);
      users = await res.json();
    }
  </script>

  <input type="text" bind:value={searchTerm} placeholder="جستجوی کاربر..." />
  <table>
    {#each users as user}
      <tr>
        <td>{user.name}</td>
        <td>{user.email}</td>
        <td>
          <select value={user.role} on:change={(e) => updateRole(user.id, e.target.value)}>
            <option value="user">کاربر معمولی</option>
            <option value="admin">ادمین</option>
          </select>
        </td>
      </tr>
    {/each}
  </table>
  ```

---

### **۴. امنیت پنل مدیریت**  
- **راهکارها:**  
  - استفاده از **HTTP-only Cookies** برای توکن JWT  
  - **CSRF Protection** در فرم‌ها  
  - **IP Whitelisting** برای دسترسی به پنل  
  - **Audit Log** برای ثبت فعالیت‌های ادمین  

- **مثال Audit Log در Go:**  
```go
type AuditLog struct {
    AdminID    string    `json:"admin_id"`  
    Action     string    `json:"action"`  // مثال: "UPDATE_PRODUCT"  
    TargetID   string    `json:"target_id"`  
    Timestamp  time.Time `json:"timestamp"`  
}

func LogAdminAction(c *gin.Context, action string, targetID string) {
    adminID := c.GetString("user_id")  
    logEntry := AuditLog{
        AdminID:   adminID,  
        Action:    action,  
        TargetID:  targetID,  
        Timestamp: time.Now(),  
    }  
    // ذخیره در دیتابیس  
}
```

---

### **۵. گزارش‌گیری و تحلیل داده**  
#### **الف) نمودار فروش با Chart.js**  
```svelte
<!-- src/routes/admin/analytics/SalesChart.svelte -->  
<script>
  import { Chart } from 'chart.js/auto';
  let canvas;

  onMount(async () => {
    const res = await fetch('/api/admin/analytics/sales');
    const data = await res.json();
    
    new Chart(canvas, {
      type: 'line',
      data: {
        labels: data.labels, // ماه‌ها
        datasets: [{
          label: 'فروش ماهانه',
          data: data.values,
          borderColor: '#3B82F6',
        }]
      }
    });
  });
</script>

<canvas bind:this={canvas} />
```

#### **ب) API گزارش‌گیری در Go**  
```go
// handlers/analytics.go  
func GetSalesAnalytics(c *gin.Context) {
    query := `
        SELECT 
            DATE_TRUNC('month', created_at) AS month,
            SUM(total) AS sales
        FROM orders
        GROUP BY month
        ORDER BY month
    `
    rows, _ := db.Query(query)
    // پردازش داده و بازگشت JSON
}
```

---

### **۶. تست پنل مدیریت**  
#### **الف) تست End-to-End با Cypress**  
```javascript
// cypress/e2e/admin.cy.js  
describe('Admin Panel', () => {
    it('Should login and manage users', () => {
        cy.loginAsAdmin();
        cy.visit('/admin/users');
        cy.get('table').should('contain', 'admin@example.com');
        cy.get('select').first().select('admin');
        cy.contains('تغییرات ذخیره شد').should('be.visible');
    });
});
```

#### **ب) تست نشست‌های ادمین در Go**  
```go
func TestAdminAccess(t *testing.T) {
    // ایجاد درخواست با توکن کاربر معمولی
    req, _ := http.NewRequest("GET", "/api/admin/users", nil)
    req.Header.Add("Authorization", "Bearer user_token")
    
    w := httptest.NewRecorder()
    r.ServeHTTP(w, req)
    
    assert.Equal(t, 403, w.Code) // باید خطای 403 بدهد
}
```

---

### **۷. استقرار پنل مدیریت**  
- **نکات:**  
  - جدا کردن محیط **Admin** و **Public** در DNS:  
    - `admin.ma2ta.com` برای پنل مدیریت  
    - `www.ma2ta.com` برای فروشگاه  
  - استفاده از **Web Application Firewall (WAF)**  
  - **Rate Limiting** شدیدتر برای APIهای ادمین  

---

**نمونه خروجی پنل مدیریت:**  
![پنل مدیریت Ma2tA](https://via.placeholder.com/800x600/3B82F6/FFFFFF?text=Ma2tA+Admin+Panel)  

---

با این معماری، پنل مدیریت Ma2tA به‌صورت **امن**، **مقیاس‌پذیر** و **کاربرپسند** پیاده‌سازی می‌شود! 🚀