**پیاده‌سازی جستجوی پیشرفته در پروژه Ma2tA**  
برای افزودن جستجوی پیشرفته با قابلیت فیلترهای چندگانه و جستجوی هوشمند، مراحل زیر را دنبال کنید:

---

### **۱. طراحی ویژگی‌های جستجوی پیشرفته**
- **فیلترهای اصلی:**  
  - قیمت (حداقل/حداکثر)  
  - دسته‌بندی  
  - برند  
  - امتیاز (Rating)  
  - موجودی انبار  
- **جستجوی متنی:**  
  - جستجو در نام محصول، توضیحات و برچسب‌ها (Tags)  
- **مرتب‌سازی:**  
  - جدیدترین، پربازدیدترین، ارزان‌ترین، گران‌ترین  

---

### **۲. پیاده‌سازی در بک‌اند (Go + Gin)**

#### **الف) پارامترهای Query API**
```go
type ProductFilter struct {
    Query      string   `form:"q"`
    Category   string   `form:"category"`
    Brand      string   `form:"brand"`
    MinPrice   float64  `form:"minPrice"`
    MaxPrice   float64  `form:"maxPrice"`
    Rating     int      `form:"rating"`
    SortBy     string   `form:"sortBy"` // قیمت، تاریخ، امتیاز
    InStock    bool     `form:"inStock"`
    Page       int      `form:"page"`
    Limit      int      `form:"limit"`
}
```

#### **ب) ساخت Query داینامیک برای SQL**
```go
func buildProductQuery(filter ProductFilter) (string, []interface{}) {
    baseQuery := "SELECT * FROM products WHERE 1=1"
    var args []interface{}
    
    if filter.Query != "" {
        baseQuery += " AND (name ILIKE ? OR description ILIKE ?)"
        args = append(args, "%"+filter.Query+"%", "%"+filter.Query+"%")
    }
    
    if filter.Category != "" {
        baseQuery += " AND category = ?"
        args = append(args, filter.Category)
    }
    
    if filter.MinPrice > 0 {
        baseQuery += " AND price >= ?"
        args = append(args, filter.MinPrice)
    }
    
    // سایر فیلترها...
    
    // مرتب‌سازی
    switch filter.SortBy {
    case "price_asc":
        baseQuery += " ORDER BY price ASC"
    case "price_desc":
        baseQuery += " ORDER BY price DESC"
    }
    
    // صفحه‌بندی
    baseQuery += " LIMIT ? OFFSET ?"
    args = append(args, filter.Limit, (filter.Page-1)*filter.Limit)
    
    return baseQuery, args
}
```

#### **ج) API Endpoint**
```go
// handlers/product.go
func SearchProducts(c *gin.Context) {
    var filter ProductFilter
    if err := c.ShouldBindQuery(&filter); err != nil {
        c.JSON(400, gin.H{"error": "پارامترهای نامعتبر"})
        return
    }
    
    query, args := buildProductQuery(filter)
    rows, err := db.Query(query, args...)
    // پردازش نتایج...
}
```

---

### **۳. بهینه‌سازی عملکرد**

#### **الف) ایندکس‌گذاری در دیتابیس**
```sql
-- ایندکس برای جستجوی متنی
CREATE INDEX idx_products_search ON products 
USING GIN (to_tsvector('english', name || ' ' || description));

-- ایندکس برای قیمت و دسته‌بندی
CREATE INDEX idx_products_price ON products(price);
CREATE INDEX idx_products_category ON products(category);
```

#### **ب) کش نتایج جستجو (Redis)**
```go
// کش نتایج جستجو برای ۱ ساعت
func getCachedSearchResults(key string) ([]Product, error) {
    results, err := redisClient.Get(ctx, key).Bytes()
    // ...
}

func cacheSearchResults(key string, products []Product) {
    data, _ := json.Marshal(products)
    redisClient.Set(ctx, key, data, 1*time.Hour)
}
```

---

### **۴. پیاده‌سازی در فرانت‌اند (SvelteKit)**

#### **الف) کامپوننت فیلترها**
```svelte
<!-- src/components/SearchFilters.svelte -->
<script>
  export let categories = [];
  export let brands = [];
  
  let query = "";
  let selectedCategory = "";
  let minPrice = 0;
  let maxPrice = 10000000;
</script>

<input type="text" bind:value={query} placeholder="جستجوی محصول..." />
<select bind:value={selectedCategory}>
  <option value="">همه دسته‌ها</option>
  {#each categories as category}
    <option value={category}>{category}</option>
  {/each}
</select>
<input type="range" bind:value={minPrice} min="0" max="10000000" />
<input type="range" bind:value={maxPrice} min="0" max="10000000" />
```

#### **ب) درخواست API با پارامترهای داینامیک**
```svelte
<!-- src/routes/products.svelte -->
<script>
  let products = [];
  let filterParams = { page: 1, limit: 20 };
  
  async function fetchProducts() {
    const query = new URLSearchParams(filterParams).toString();
    const res = await fetch(`/api/products?${query}`);
    products = await res.json();
  }
  
  $: filterParams, fetchProducts();
</script>
```

---

### **۵. یکپارچه‌سازی موتور جستجوی پیشرفته (Elasticsearch)**

#### **الف) تنظیم Elasticsearch**
```docker-compose
services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.7.0
    environment:
      - discovery.type=single-node
    ports:
      - "9200:9200"
```

#### **ب) اندیس‌گذاری محصولات**
```go
type ProductDocument struct {
    ID          string   `json:"id"`
    Name        string   `json:"name"`
    Description string   `json:"description"`
    Category    string   `json:"category"`
    Price       float64  `json:"price"`
    Tags        []string `json:"tags"`
}

func IndexProduct(product Product) {
    doc := ProductDocument{/*...*/}
    esClient.Index("products", doc)
}
```

#### **ج) جستجوی پیشرفته با Query DSL**
```go
query := map[string]interface{}{
    "query": map[string]interface{}{
        "bool": map[string]interface{}{
            "must": []map[string]interface{}{
                {"match": {"name": "لپ‌تاپ"}},
                {"range": {"price": {"gte": 10000000}}},
            },
        },
    },
    "sort": []map[string]interface{}{{"price": "asc"}},
}
```

---

### **۶. امنیت جستجوی پیشرفته**
- **اعتبارسنجی پارامترها:**  
  - محدود کردن بازه قیمت (مثلاً ۰ تا ۱,۰۰۰,۰۰۰,۰۰۰ تومان)  
  - اعتبارسنجی دسته‌بندی/برند بر اساس مقادیر موجود در دیتابیس  
- **محافظت در برابر SQL Injection:**  
  - استفاده از Prepared Statements  
  - جایگزینی مستقیم پارامترها در کوئری ممنوع!  

---

### **۷. تست نهایی**
1. **تست فیلترها:**  
   ```bash
   curl "http://api.ma2ta.com/products?q=لپ‌تاپ&category=الکترونیک&minPrice=5000000"
   ```
2. **تست عملکرد:**  
   - بارگذاری ۱۰,۰۰۰ محصول و بررسی زمان پاسخ  
3. **تست امنیتی:**  
   - ارسال پارامترهای نامعتبر (مثلاً `price=abc`)  

---

**خروجی نهایی:**  
![جستجوی پیشرفته Ma2tA](https://via.placeholder.com/800x400/3B82F6/FFFFFF?text=Ma2tA+Advanced+Search)  

با این پیاده‌سازی، کاربران می‌توانند محصولات را با **دقت بالا** و **سرعت مناسب** جستجو کنند! 🔍🚀